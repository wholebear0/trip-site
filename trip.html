<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trip Map</title>
<style>
body { margin: 0; font-family: Arial, sans-serif; }
#container { display: flex; flex-wrap: wrap; height: 80vh; min-height: 500px; }
#map-container { flex: 0 0 80%; position: relative; padding: 10px; }
#map { width: 100%; height: 100%; border-radius: 8px; }
#filters { position: absolute; z-index: 999; background: white; padding: 10px; margin: 10px; border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }
#details-panel { flex: 1; background: #f9f9f9; padding: 15px; overflow-y: auto; border-left: 1px solid #ccc; display: none; border-radius: 8px; }
#details-panel img { width: 100%; max-height: 300px; object-fit: cover; margin-bottom: 10px; border-radius: 6px; }
#details-panel h2 { margin: 5px 0; color: #333; }
#details-panel p { margin: 4px 0; font-size: 14px; }
#details-panel .close-panel { background: #444; color: #fff; border: none; padding: 5px 10px; float: right; cursor: pointer; border-radius: 4px; margin-bottom: 10px; }
#details-panel .go-to-page-btn { background-color: #28a745; color: white; padding: 12px 24px; border: none; border-radius: 6px; font-size: 18px; cursor: pointer; display: block; width: 100%; margin-top: 20px; text-align: center; font-weight: bold; }
#details-panel .go-to-page-btn:hover { background-color: #218838; }
@media (max-width: 900px) {
  #container { flex-direction: column; }
  #details-panel { border-left: none; border-top: 1px solid #ccc; flex: none; height: 50vh; }
}
</style>
</head>
<body>

<div id="filters">
  <label>
    Type:
    <select id="typeFilter">
      <option value="All">All</option>
      <option value="Hike">Hike</option>
      <option value="Backpack">Backpack</option>
      <option value="Kayak">Kayak</option>
      <option value="Other">Other</option>
    </select>
  </label>
</div>

<div id="container">
  <div id="map-container">
    <div id="map"></div>
  </div>
  <div id="details-panel">
    <button class="close-panel">Close</button>
    <div id="details-content"></div>
  </div>
</div>

<!-- Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key=AKfycbykGnPgEoQ-VGN3x3hOwKLvu1yoClbebiN2_Tpi0pFbQwWHlDdMwLywlJPIarn6PpKu"></script>

<script>
// Replace this with your deployed Apps Script Web App URL
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbykGnPgEoQ-VGN3x3hOwKLvu1yoClbebiN2_Tpi0pFbQwWHlDdMwLywlJPIarn6PpKu/exec";

window.addEventListener("load", function() {
  const mapDiv = document.getElementById("map");
  const typeFilter = document.getElementById("typeFilter");
  const detailsPanel = document.getElementById("details-panel");
  const detailsContent = document.getElementById("details-content");
  const closePanelBtn = detailsPanel.querySelector(".close-panel");

  let allMarkersData = [];
  let mapMarkers = [];

  const map = new google.maps.Map(mapDiv, {
    center: { lat: 36.805098, lng: -109.822512 },
    zoom: 6,
    mapTypeId: google.maps.MapTypeId.TERRAIN,
    disableDefaultUI: true
  });

  function getMarkerIcon(type) {
    switch(type.toLowerCase()) {
      case "hike": return "https://maps.google.com/mapfiles/ms/icons/blue-dot.png";
      case "backpack": return "https://maps.google.com/mapfiles/ms/icons/red-dot.png";
      case "kayak": return "https://maps.google.com/mapfiles/ms/icons/green-dot.png";
      case "other": return "https://maps.google.com/mapfiles/ms/icons/yellow-dot.png";
      default: return "https://maps.google.com/mapfiles/ms/icons/purple-dot.png";
    }
  }

  // Load trip data from Apps Script
  fetch(APPS_SCRIPT_URL)
    .then(res => res.json())
    .then(data => {
      allMarkersData = data.cardItems;
      updateMarkers();
    })
    .catch(err => console.error("Failed to load sheet data:", err));

  function updateMarkers() {
    mapMarkers.forEach(m => m.setMap(null));
    mapMarkers = [];

    const bounds = map.getBounds();
    if (!bounds) return;

    const selectedType = typeFilter.value;

    allMarkersData.forEach(d => {
      if(selectedType !== "All" && d.type !== selectedType) return;
      if(!d.position) return;

      const position = new google.maps.LatLng(d.position.lat, d.position.lng);
      if (bounds.contains(position)) {
        const marker = new google.maps.Marker({
          position,
          map,
          icon: getMarkerIcon(d.type)
        });

        marker.addListener("click", () => showDetails(d));
        mapMarkers.push(marker);
      }
    });
  }

  function showDetails(data) {
    detailsContent.innerHTML = `
      ${data.imageUrl ? `<img src="${data.imageUrl}" alt="${data.title}">` : ""}
      <h2>${data.title}</h2>
      <p><strong>Area:</strong> ${data.area}</p>
      <p><strong>Date:</strong> ${data.date}</p>
      <p><strong>Miles:</strong> ${data.miles}</p>
      <p><strong>Elevation Gain:</strong> ${data.elevationGain}</p>
      <p><strong>Overall Ranking:</strong> ${data.overallRanking}</p>
      <button class="go-to-page-btn">Go to Page</button>
    `;
    detailsPanel.style.display = "block";

    const goToPageBtn = detailsPanel.querySelector(".go-to-page-btn");
    goToPageBtn.addEventListener("click", () => {
      const slug = data.title.toLowerCase().replace(/\s+/g,'-');
      // Opens a separate gallery page
      window.location.href = `trip-gallery.html?slug=${slug}`;
    });
  }

  closePanelBtn.addEventListener("click", () => {
    detailsPanel.style.display = "none";
  });

  map.addListener("bounds_changed", updateMarkers);
  typeFilter.addEventListener("change", updateMarkers);
});
</script>
</body>
</html>
