<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Travel Map</title>

<style>
body { margin:0; font-family: Arial,sans-serif; background:#f2f2f2; }

/* ===== HEADER ===== */
.header {
  position: fixed;
  top: 0;
  width: 100%;
  z-index: 999;
  background:#333; 
  color:white; 
  text-align:center; 
  padding:12px 20px;
}
.header h1 { margin:0; font-size:24px; }
.header p { margin:3px 0 0; font-size:14px; }

/* ===== SPACING FOR FIXED HEADER ===== */
body { padding-top:60px; }

/* ===== FILTER ===== */
#filters {
  position:absolute; z-index:999;
  background:white; padding:10px; margin:10px;
  border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.3);
}

/* ===== MAP + SIDEBAR ===== */
#container {
  display:flex;
  height:80vh;
  min-height:500px;
}

#map-container { flex:3; padding:10px; }
#map { width:90%; height:90%; }

#details-panel {
  flex:1;
  background:#f9f9f9;
  padding:15px;
  overflow-y:auto;
  border-left:1px solid #ccc;
}
#details-panel img { width:100%; margin-bottom:15px; }

.go-to-page-btn {
  background:#28a745; color:white; padding:12px;
  border:none; width:70%; font-size:18px;
  cursor:pointer; margin-top:15px;
}
.go-to-page-btn:hover { background:#218838; }

/* ===== TRIP CARDS SECTION ===== */
.cards-container {
  display:flex;
  flex-direction:column;
  gap:20px;
  max-width:1200px;
  margin:40px auto;
  padding:0 10px;
}

.trip-card {
  display:flex;
  background:#fff;
  cursor:pointer;
  border-radius:8px;
  overflow:hidden;
  box-shadow:0 4px 10px rgba(0,0,0,0.15);
  transition: transform 0.2s, box-shadow 0.2s;
}
.trip-card:hover {
  transform: translateY(-4px);
  box-shadow:0 6px 14px rgba(0,0,0,0.2);
}

.trip-info {
  flex:.8;
  background:#333;
  color:white;
  padding:20px;
  min-width:180px;
  display:flex;
  flex-direction:column;
  justify-content:center;
  gap:6px;
}
.trip-info p { margin:2px 0; font-size:14px; }

.trip-photo {
  flex:3.2;
  background-size:cover;
  background-position:center;
  min-height:400px;
}

/* ===== SPACER ===== */
.spacer { height:30px; }

.show-more-btn {
  margin: 20px auto;
  display: block;
  padding: 12px 24px;
  font-size: 16px;
  cursor: pointer;
  background: #333;
  color: white;
  border: none;
  border-radius: 6px;
}
.show-more-btn:hover {
  background: #555;
}
</style>
</head>
<body>

<!-- ===== HEADER ===== -->
<div class="header">
  <h1>My Travel Map</h1>
  <p>Click a location to view the trip gallery</p>
</div>

<!-- ===== FILTER ===== -->
<div id="filters">
  <label>
    Type:
    <select id="typeFilter">
      <option value="All">All</option>
      <option value="Hike">Hike</option>
      <option value="Backpack">Backpack</option>
      <option value="Kayak">Kayak</option>
      <option value="Other">Other</option>
    </select>
  </label>
</div>

<!-- ===== MAP + SIDEBAR ===== -->
<div id="container">
  <div id="map-container">
    <div id="map"></div>
  </div>
  <div id="details-panel">
    <div id="details-content">Loading...</div>
  </div>
</div>

<!-- ===== SPACER ===== -->
<div class="spacer"></div>

<!-- ===== TRIP CARDS SECTION ===== -->
<div class="cards-container" id="cards-container">
  Loading trips...
</div>

<script>
/* ===== CONFIG ===== */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby_5e7cG_REtJkwr6TPDp4oWLoi6H52u3EBswtjLmzvM1UT5bSxDKp3P4SQ5tBoMMYf/exec";
const GOOGLE_MAPS_KEY = "AIzaSyCMCxxUBxZ-a2UyHwu5PbKwYBxvAo0bAAA";

/* ===== MAP ===== */
let map;
let allMarkersData = [];
let mapMarkers = [];

function initMap(){
  map = new google.maps.Map(document.getElementById("map"),{
    center:{lat:36.805098,lng:-109.822512},
    zoom:6,
    mapTypeId:"terrain",
    gestureHandling:"greedy",
    disableDefaultUI:true
  });
  loadTrips();
}

function loadTrips(){
  fetch(SCRIPT_URL)
    .then(res=>res.json())
    .then(data=>{
      allMarkersData = data.cardItems;
      updateMarkers();

      const sorted = [...allMarkersData].sort((a,b)=> new Date(b.date)-new Date(a.date));
      if(sorted.length) showDetails(sorted[0]);

      // Also load trip cards below map
      loadTripCards(data.cardItems);
    });
}

function getMarkerIcon(type){
  switch(type?.toLowerCase()){
    case "hike": return "https://maps.google.com/mapfiles/ms/icons/blue-dot.png";
    case "backpack": return "https://maps.google.com/mapfiles/ms/icons/red-dot.png";
    case "kayak": return "https://maps.google.com/mapfiles/ms/icons/green-dot.png";
    default: return "https://maps.google.com/mapfiles/ms/icons/yellow-dot.png";
  }
}

function updateMarkers(){
  mapMarkers.forEach(m=>m.setMap(null));
  mapMarkers=[];

  const selected = document.getElementById("typeFilter").value;
  allMarkersData.forEach(d=>{
    if(selected!=="All" && d.type!==selected) return;
    if(!d.position) return;

    const marker = new google.maps.Marker({
      position:d.position,
      map,
      icon:getMarkerIcon(d.type)
    });
    marker.addListener("click",()=>showDetails(d));
    mapMarkers.push(marker);
  });
}

document.getElementById("typeFilter").addEventListener("change",updateMarkers);

function showDetails(data){
  const urls = data.imageUrl?.split(",").map(u=>u.trim()) || [];
  const imagesHtml = urls.map(u=>`<img src="${u}">`).join("");
  document.getElementById("details-content").innerHTML=`
    <h2>${data.title}</h2>
    ${imagesHtml}
    <p><strong>Area:</strong> ${data.area}</p>
    <p><strong>Date:</strong> ${data.date}</p>
    <p><strong>Miles:</strong> ${data.miles}</p>
    <p><strong>Elevation Gain:</strong> ${data.elevationGain}</p>
    <button class="go-to-page-btn">Go to Page</button>
  `;
  document.querySelector(".go-to-page-btn").onclick=()=>{
    const slug = data.title.toLowerCase().replace(/\s+/g,'-');
    window.location.href = `trip-gallery.html?slug=${slug}`;
  };
}

/* ===== TRIP CARDS BELOW MAP ===== */
const MAX_CARDS = 50;
let currentCardCount = 0;

function loadTripCards(trips){
  const container = document.getElementById('cards-container');
  container.innerHTML='';
  const sorted = trips.sort((a,b)=> new Date(b.date)-new Date(a.date));

  function createCard(trip){
    const slug = trip.title.toLowerCase().replace(/\s+/g,'-');
    const photo = trip.imageUrl || '';

    const card = document.createElement('div');
    card.className='trip-card';
    card.onclick=()=> window.location.href=`trip-gallery.html?slug=${slug}`;

    card.innerHTML=`
      <div class="trip-info">
        <p><strong>Hike:</strong> ${trip.title}</p>
        <p><strong>Area:</strong> ${trip.area || ''}</p>
        <p><strong>Date:</strong> ${trip.date}</p>
        <p><strong>Miles:</strong> ${trip.miles || 0}</p>
        <p><strong>Elevation Gain:</strong> ${trip.elevationGain || 0}</p>
        <p><strong>Type:</strong> ${trip.type || ''}</p>
      </div>
      <div class="trip-photo" style="background-image:url('${photo}')"></div>
    `;
    return card;
  }

  function renderBatch(){
    const batch = sorted.slice(currentCardCount, currentCardCount + MAX_CARDS);
    batch.forEach(trip=> container.appendChild(createCard(trip)));
    currentCardCount += batch.length;

    // Add "Show More" button if needed
    if(currentCardCount < sorted.length){
      let btn = container.querySelector('.show-more-btn');
      if(!btn){
        btn = document.createElement('button');
        btn.className='show-more-btn';
        btn.innerText='Show More';
        btn.onclick=renderBatch;
        container.appendChild(btn);
      }
    } else {
      const btn = container.querySelector('.show-more-btn');
      if(btn) btn.remove();
    }
  }

  renderBatch();
}
</script>

<!-- Google Maps Loader -->
<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMCxxUBxZ-a2UyHwu5PbKwYBxvAo0bAAA&callback=initMap">
</script>

</body>
</html>
