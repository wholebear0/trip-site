<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Travel Map</title>
<style>
  body { margin:0; font-family: Arial,sans-serif; background:#f2f2f2; }

  .header {
    background: #333; color: white; text-align: center; padding: 20px;
  }
  .header h1 { margin:0; font-size:32px; }
  .header p { margin:5px 0 0; font-size:16px; }

  /* Filters dropdown */
  #filters {
    position: absolute;
    z-index: 999;
    background:white;
    padding:10px;
    margin:10px;
    border-radius:6px;
    box-shadow:0 2px 6px rgba(0,0,0,0.3);
  }

  /* Container for map and sidebar */
  #container {
    display:flex;
    flex-wrap: wrap;
  }

  #map {
    flex: 1 1 70%;
    height: 80vh;
    min-height: 500px;
  }

  /* Sidebar */
  #details-panel {
    flex: 0 0 30%;
    background:#f9f9f9;
    padding:15px;
    overflow-y:auto;
    border-left:1px solid #ccc;
    max-height: 80vh;
  }
  #details-panel img {
    width: 100%;
    margin-bottom: 10px;
    border-radius: 0; /* square corners */
  }
  #details-panel h2 { margin:5px 0; color:#333; }
  #details-panel p { margin:4px 0; font-size:14px; }
  #details-panel .go-to-page-btn {
    background-color:#28a745;
    color:white;
    padding:12px 24px;
    border:none;
    border-radius:6px;
    font-size:18px;
    cursor:pointer;
    display:block;
    width:100%;
    margin-top:20px;
    text-align:center;
    font-weight:bold;
  }
  #details-panel .go-to-page-btn:hover { background-color:#218838; }

  /* Below-map content */
  .below-map {
    padding:40px;
    text-align:center;
    background:#ffffff;
  }

  @media(max-width:900px){
    #container { flex-direction: column; }
    #map { height:50vh; }
    #details-panel { width:95%; max-height:400px; border-left:none; border-top:1px solid #ccc; margin:10px auto; }
  }

</style>
</head>

<body>

<div class="header">
  <h1>My Travel Map</h1>
  <p>Click a location to update the trip gallery</p>
</div>

<div id="filters">
  <label>
    Type:
    <select id="typeFilter">
      <option value="All">All</option>
      <option value="Hike">Hike</option>
      <option value="Backpack">Backpack</option>
      <option value="Kayak">Kayak</option>
      <option value="Other">Other</option>
    </select>
  </label>
</div>

<div id="container">
  <div id="map"></div>
  <div id="details-panel">
    <div id="details-content">Loading...</div>
  </div>
</div>

<div class="below-map">
  <h2>Extra Content / Embed Here</h2>
  <p>Add videos, links, or widgets</p>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMCxxUBxZ-a2UyHwu5PbKwYBxvAo0bAAA"></script>

<script>
window.addEventListener("load", function(){
  const mapDiv = document.getElementById("map");
  const typeFilter = document.getElementById("typeFilter");
  const detailsContent = document.getElementById("details-content");

  const map = new google.maps.Map(mapDiv,{
    center:{lat:36.805098,lng:-109.822512},
    zoom:6,
    mapTypeId: google.maps.MapTypeId.TERRAIN,
    disableDefaultUI:true
  });

  function getMarkerIcon(type){
    switch(type.toLowerCase()){
      case "hike": return "https://maps.google.com/mapfiles/ms/icons/blue-dot.png";
      case "backpack": return "https://maps.google.com/mapfiles/ms/icons/red-dot.png";
      case "kayak": return "https://maps.google.com/mapfiles/ms/icons/green-dot.png";
      case "other": return "https://maps.google.com/mapfiles/ms/icons/yellow-dot.png";
    }
  }

  let allMarkersData=[];
  let mapMarkers=[];

  fetch("https://script.google.com/macros/s/AKfycbwoUNNQZsKfLkEYcc4DfyVQkzuc3BGGXd-DDV0dAfMHhhE5i_FY3Bq5z8PBUhg2teot/exec")
    .then(res=>res.json())
    .then(data=>{
      allMarkersData = data.cardItems;
      updateMarkers();

      // Show the most recent hike in sidebar on load
      const recent = allMarkersData[allMarkersData.length-1];
      if(recent) showDetails(recent);
    }).catch(err=>console.error("Markers load failed", err));

  function updateMarkers(){
    mapMarkers.forEach(m=>m.setMap(null));
    mapMarkers=[];
    const selectedType = typeFilter.value;

    allMarkersData.forEach(d=>{
      if(selectedType!=="All" && d.type!==selectedType) return;
      const position = new google.maps.LatLng(d.position.lat,d.position.lng);
      const marker = new google.maps.Marker({position,map,icon:getMarkerIcon(d.type)});
      marker.addListener("click",()=>showDetails(d));
      mapMarkers.push(marker);
    });
  }

  typeFilter.addEventListener("change",updateMarkers);

  function showDetails(data){
    const urls = data.imageUrl ? data.imageUrl.split(",") : [];
    const imagesHtml = urls.map(u=>`<img src="${u.trim()}" alt="${data.title}">`).join("");

    detailsContent.innerHTML = `
      <h2>${data.title}</h2>
      ${imagesHtml}
      <p><strong>Area:</strong> ${data.area}</p>
      <p><strong>Date:</strong> ${data.date}</p>
      <p><strong>Miles:</strong> ${data.miles}</p>
      <p><strong>Elevation Gain:</strong> ${data.elevationGain}</p>
      <p><strong>Overall Ranking:</strong> ${data.overallRanking}</p>
      <button class="go-to-page-btn">Go to Page</button>
    `;

    const goToPageBtn = detailsContent.querySelector(".go-to-page-btn");
    goToPageBtn.addEventListener("click",()=>{
      const slug = data.title.toLowerCase().replace(/\s+/g,'-');
      window.location.href = `trip-gallery.html?slug=${slug}`;
    });
  }

});
</script>

</body>
</html>
