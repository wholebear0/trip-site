<div class="photos-container" id="photos-container"></div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz3dwxVyzavcZdRys0HpmEQmWTG-Mvs74alj2m_mM1MCG2xK-BUjTm-EEthF2tghAJ0/exec";

const params = new URLSearchParams(window.location.search);
const slug = params.get("slug");

function makeSlug(text){
  return text.toLowerCase().replace(/\s+/g,"-");
}

function initTripGallery(){

  fetch(SCRIPT_URL)
  .then(res => res.json())
  .then(data => {

    const trip = data.cardItems.find(t => makeSlug(t.title) === slug);

    if(!trip){
      document.getElementById("trip-title").innerText = "Trip not found";
      return;
    }

    document.getElementById("trip-title").innerText = trip.title;

    document.getElementById("trip-info").innerHTML = `
      <p><strong>Date:</strong> ${trip.date || ""}</p>
      <p><strong>Area:</strong> ${trip.area || ""}</p>
      <p><strong>Miles:</strong> ${trip.miles || ""}</p>
      <p><strong>Elevation Gain:</strong> ${trip.elevationGain || ""}</p>
      <p><strong>Type:</strong> ${trip.type || ""}</p>
    `;

    document.getElementById("trip-cover").innerHTML =
      `<img src="${trip.imageUrl || ""}" alt="${trip.title}" loading="lazy">`;

    const map = new google.maps.Map(
      document.getElementById("trip-map"),
      {
        center: trip.position,
        zoom: 10,
        mapTypeId: "terrain",
        disableDefaultUI: true
      }
    );

    new google.maps.Marker({
      position: trip.position,
      map: map
    });

    const writeupText = trip.WriteUp || "";
    document.getElementById("trip-writeup").innerHTML =
      writeupText.replace(/\n/g,"<br>");

    // ===== Updated photos logic =====
    const rawUrls = data.images[slug] || [];
    const galleryHTML = rawUrls.map(item => {
      item = item.trim();
      if(!item) return "";

      // Split into URL and caption
      const [url, caption] = item.split('|');
      let figure = `<figure><img src="${url}" alt="${caption || trip.title}" loading="lazy">`;
      if(caption) figure += `<figcaption>${caption}</figcaption>`;
      figure += `</figure>`;
      return figure;
    }).join("");

    document.getElementById("photos-container").innerHTML = galleryHTML;

  })
  .catch(err=>{
    console.error(err);
    document.getElementById("trip-title").innerText =
      "Failed to load trip data";
  });
}

function loadGoogleMaps(){
  const s = document.createElement("script");
  s.src =
    "https://maps.googleapis.com/maps/api/js?key=AIzaSyCMCxxUBxZ-a2UyHwu5PbKwYBxvAo0bAAA&callback=initTripGallery";
  s.defer = true;
  document.head.appendChild(s);
}

loadGoogleMaps();
</script>
